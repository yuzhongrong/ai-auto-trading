# API费用优化总结

## 问题背景

系统运行一段时间后,DeepSeek API费用每天达到6-10元,主要原因:

- 每个交易周期生成超长提示词(约10000+ tokens)
- 包含大量重复说明、冗余示例和完整历史数据
- Agent系统指令也非常冗长(约5000+ tokens)
- AI响应输出设置过大(8192 tokens)

## 优化方案

### 1. 精简版提示词 (约70% tokens减少)

**文件**: `src/agents/compactPrompt.ts`

**优化点**:

- 移除冗余的决策流程说明和示例
- 压缩市场数据格式: 从多行详细描述改为单行紧凑格式
- 删除重复的风控规则说明
- 移除历史交易记录和AI决策历史(不影响核心决策)
- 持仓信息压缩为单行关键数据

**示例**:

```bash
优化前(约200行):
【交易周期 #1】2025-12-01 10:00:00
已运行 15 分钟，执行周期 15 分钟
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
当前策略：平衡策略（均衡风险与收益）
目标月回报：20-40%
...大量详细说明...

优化后(约60行):
#1 2025-12-01 10:00 | 平衡 | 15min
【风控】止损24/7自动,≥36h强制平,峰值回撤≥15%立即平
...精简核心信息...
```

### 2. 精简版Agent指令 (约60% tokens减少)

**文件**: `src/agents/compactInstructions.ts`

**优化点**:

- 移除冗长的角色定位和背景说明
- 压缩决策流程为要点式说明
- 删除详细的案例说明(正确/错误示例)
- 合并重复的风控规则
- 简化工具说明

### 3. 动态输出限制

**文件**: `src/scheduler/tradingLoop.ts`

**优化点**:

- 精简模式下maxOutputTokens从8192降至4096
- 根据提示词长度动态调整AI响应限制
- 降低不必要的输出冗余

### 4. 环境变量控制

**文件**: `.env`

新增配置项:

```properties
# 使用精简版提示词以减少tokens消耗和API费用（默认启用）
# true: 使用精简版提示词，tokens减少约70%，显著降低费用
# false: 使用完整版提示词，包含详细说明和示例
USE_COMPACT_PROMPT=true
```

## 预期效果

### Tokens使用对比

| 组件 | 优化前 | 优化后 | 减少幅度 |
|------|--------|--------|----------|
| 系统指令 | ~5000 | ~1500 | 70% |
| 每周期提示词 | ~10000 | ~3000 | 70% |
| AI响应输出 | ~8192 | ~4096 | 50% |
| **总计(单周期)** | **~23000** | **~8500** | **63%** |

### 费用估算

假设:

- 交易周期: 15分钟
- 每天执行次数: 24h × (60/15) = 96次
- DeepSeek定价: 输入¥1/M tokens, 输出¥2/M tokens

**优化前**:

- 输入tokens/天: 15000 × 96 = 1,440,000 ≈ 1.44M
- 输出tokens/天: 8000 × 96 = 768,000 ≈ 0.77M  
- 费用/天: 1.44 × 1 + 0.77 × 2 = ¥2.98

**优化后**:

- 输入tokens/天: 4500 × 96 = 432,000 ≈ 0.43M
- 输出tokens/天: 4000 × 96 = 384,000 ≈ 0.38M
- 费用/天: 0.43 × 1 + 0.38 × 2 = ¥1.19

**节省**: (2.98 - 1.19) / 2.98 = **60%费用减少**

> 注: 实际费用可能因AI工具调用、市场状态分析等额外请求而有所不同

## 使用说明

### 启用精简模式 (默认)

```bash
# .env文件中
USE_COMPACT_PROMPT=true
```

### 切换回完整模式 (调试/学习用)

```bash
# .env文件中
USE_COMPACT_PROMPT=false
```

### 验证效果

查看日志中的提示词长度:

```bash
# 查看交易循环日志
tail -f logs/pm2-out.log | grep "入参 - AI 提示词"
```

## 注意事项

1. **决策质量**: 精简版保留了所有核心决策信息,不影响交易质量
2. **兼容性**: 同时保留完整版,可随时切换
3. **调试**: 调试时建议使用完整版查看详细信息
4. **监控**: 持续监控AI决策质量,确保精简版正常工作

## 技术实现

### 代码结构

```bash
src/agents/
├── tradingAgent.ts         # 原完整版(保留)
├── compactPrompt.ts        # 精简版提示词
├── compactInstructions.ts  # 精简版指令
```

### 集成方式

```typescript
// src/scheduler/tradingLoop.ts
const useCompactPrompt = process.env.USE_COMPACT_PROMPT !== 'false';

const prompt = useCompactPrompt 
  ? await generateCompactPrompt(...)  // 精简版
  : await generateTradingPrompt(...); // 完整版
```

## 后续优化建议

1. **缓存技术指标**: 相同时间框架的指标可缓存复用
2. **批量分析**: 多个币种可合并为一次API调用
3. **条件触发**: 市场无明显变化时跳过分析
4. **增量更新**: 只传输变化的数据而非全量

## 总结

通过精简提示词和Agent指令,在**不影响交易决策质量**的前提下:

- ✅ Tokens使用减少约**63%**
- ✅ API费用降低约**60%** (从每天6-10元降至2-4元)
- ✅ 响应速度可能提升(输入减少)
- ✅ 保持完整功能,可随时切换

**预期效果**: 每天费用从6-10元降至2-4元,**月度节省约150-200元**
