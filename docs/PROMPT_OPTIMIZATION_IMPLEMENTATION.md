# AI Prompt ä¼˜åŒ–å®æ–½è®°å½•

## ğŸ“… å®æ–½æ—¥æœŸ

2025-01-XX

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

è§£å†³ AI Agent åœ¨æ‰§è¡Œåˆ†æ‰¹æ­¢ç›ˆå’Œç§»åŠ¨æ­¢æŸæ—¶å¯èƒ½äº§ç”Ÿçš„å·¥å…·è°ƒç”¨å†²çªé—®é¢˜ã€‚

---

## âœ… å·²å®æ–½çš„ä¼˜åŒ–

### ä¼˜åŒ–1: å·¥å…·å±‚å†·å´æœŸæ£€æŸ¥ âœ…

**æ–‡ä»¶:** `/src/tools/trading/stopLossManagement.ts`

**å˜æ›´å†…å®¹:**
åœ¨ `updateTrailingStopTool` çš„ `execute` å‡½æ•°ä¸­æ·»åŠ å†·å´æœŸæ£€æŸ¥æœºåˆ¶:

```typescript
// æ£€æŸ¥è¯¥æŒä»“æ˜¯å¦åœ¨æœ€è¿‘5åˆ†é’Ÿå†…æ‰§è¡Œè¿‡åˆ†æ‰¹æ­¢ç›ˆ
const recentPartialTakeProfit = await dbClient.execute({
  sql: `SELECT timestamp FROM partial_take_profit_history 
        WHERE symbol = ? AND status = 'completed' 
        ORDER BY timestamp DESC LIMIT 1`,
  args: [symbol],
});

if (recentPartialTakeProfit.rows.length > 0) {
  const lastExecutionTime = new Date(recentPartialTakeProfit.rows[0].timestamp as string);
  const now = new Date();
  const minutesSinceLastExecution = (now.getTime() - lastExecutionTime.getTime()) / (1000 * 60);
  
  // å¦‚æœåœ¨æœ€è¿‘5åˆ†é’Ÿå†…æ‰§è¡Œè¿‡åˆ†æ‰¹æ­¢ç›ˆ,æ‹’ç»ç§»åŠ¨æ­¢æŸ
  if (minutesSinceLastExecution < 5) {
    logger.info(`${symbol} åœ¨ ${minutesSinceLastExecution.toFixed(1)} åˆ†é’Ÿå‰åˆšæ‰§è¡Œè¿‡åˆ†æ‰¹æ­¢ç›ˆï¼Œå†·å´æœŸå†…æ‹’ç»ç§»åŠ¨æ­¢æŸ`);
    return {
      success: false,
      message: `${symbol} åœ¨ ${minutesSinceLastExecution.toFixed(1)} åˆ†é’Ÿå‰åˆšæ‰§è¡Œè¿‡åˆ†æ‰¹æ­¢ç›ˆï¼Œæœ¬å‘¨æœŸæ— éœ€å†æ¬¡è°ƒæ•´æ­¢æŸï¼ˆå†·å´æœŸï¼š5åˆ†é’Ÿï¼‰`,
    };
  }
}
```

**ä¿æŠ¤æœºåˆ¶:**

- âœ… å³ä½¿ AI è¿å prompt è§„åˆ™ï¼Œå·¥å…·å±‚ä¹Ÿä¼šæ‹’ç»æ‰§è¡Œ
- âœ… åŒé‡ä¿æŠ¤ï¼šPrompt è§„åˆ™ + å·¥å…·å±‚éªŒè¯
- âœ… å†·å´æœŸï¼š5åˆ†é’Ÿï¼ˆå¯é…ç½®ï¼‰
- âœ… æ¸…æ™°çš„æ—¥å¿—è®°å½•å’Œç”¨æˆ·åé¦ˆ

**ä¾èµ–å˜æ›´:**

- æ·»åŠ äº† `@libsql/client` å¯¼å…¥
- åˆ›å»ºäº† `dbClient` å®ä¾‹ç”¨äºæŸ¥è¯¢ `partial_take_profit_history` è¡¨

---

### ä¼˜åŒ–2: AI Prompt æ¡ˆä¾‹è¯´æ˜ âœ…

**æ–‡ä»¶:** `/src/agents/tradingAgent.ts`

**å˜æ›´å†…å®¹:**
åœ¨"å·¥å…·è°ƒç”¨è§„åˆ™"ç« èŠ‚åï¼Œæ·»åŠ äº†è¯¦ç»†çš„"å·¥å…·è°ƒç”¨æ¡ˆä¾‹è¯´æ˜"ï¼š

**æ–°å¢å†…å®¹åŒ…æ‹¬:**

1. **æ­£ç¡®æ¡ˆä¾‹1: åˆ†æ‰¹æ­¢ç›ˆä¼˜å…ˆï¼Œé¿å…é‡å¤**
   - å±•ç¤ºå®Œæ•´çš„åˆ†æ‰¹æ­¢ç›ˆæµç¨‹
   - å¼ºè°ƒæ‰§è¡Œåä¸å†è°ƒç”¨ updateTrailingStop

2. **æ­£ç¡®æ¡ˆä¾‹2: ç§»åŠ¨æ­¢æŸä¼˜åŒ–**
   - é€‚ç”¨äºæœªè¾¾åˆ°åˆ†æ‰¹æ­¢ç›ˆé˜ˆå€¼çš„åœºæ™¯
   - å±•ç¤º updateTrailingStop çš„æ­£ç¡®ç”¨æ³•

3. **é”™è¯¯æ¡ˆä¾‹1: é‡å¤ç§»åŠ¨æ­¢æŸ**
   - æ˜ç¡®æŒ‡å‡ºé”™è¯¯çš„å·¥å…·è°ƒç”¨é¡ºåº
   - è¯´æ˜å†·å´æœŸæœºåˆ¶ä¼šæ‹’ç»æ­¤ç±»æ“ä½œ

4. **é”™è¯¯æ¡ˆä¾‹2: è¯¯åˆ¤"æ¥è¿‘æ­¢æŸ"ä¸»åŠ¨å¹³ä»“**
   - çº æ­£å¸¸è§è¯¯åŒºï¼šæ¥è¿‘æ­¢æŸä¸æ˜¯å¹³ä»“ç†ç”±
   - å¼ºè°ƒä¿¡ä»»äº¤æ˜“æ‰€çš„æ­¢æŸæ¡ä»¶å•

5. **æ­£ç¡®æ¡ˆä¾‹3: æ³¢åŠ¨ç‡åŠ¨æ€è°ƒæ•´**
   - è¯´æ˜ R-Multiple æ˜¯å·¥å…·è‡ªåŠ¨è®¡ç®—çš„
   - å¼ºè°ƒ AI ä¸è¦è‡ªå·±åˆ¤æ–­é˜ˆå€¼

6. **æ­£ç¡®æ¡ˆä¾‹4: åˆ†æ‰¹æ­¢ç›ˆçš„å®Œæ•´æµç¨‹**
   - ä»å‘¨æœŸ1åˆ°å‘¨æœŸ4+çš„å®Œæ•´æ¼”ç¤º
   - å±•ç¤ºæ¯ä¸ªé˜¶æ®µçš„æ­£ç¡®æ“ä½œ

**æ ¼å¼ç‰¹ç‚¹:**

- ä½¿ç”¨ âœ… å’Œ âŒ æ ‡è®°æ­£ç¡®/é”™è¯¯åšæ³•
- ä½¿ç”¨è¡¨æƒ…ç¬¦å·å¢å¼ºå¯è¯»æ€§
- ä½¿ç”¨å…·ä½“çš„ä»·æ ¼æ•°å€¼å’Œç™¾åˆ†æ¯”ç¤ºä¾‹
- æ¸…æ™°çš„æ­¥éª¤ç¼–å·ï¼ˆ1ï¸âƒ£ 2ï¸âƒ£ 3ï¸âƒ£ï¼‰

**é¢„æœŸæ•ˆæœ:**

- å¸®åŠ© AI å»ºç«‹æ­£ç¡®çš„å·¥å…·è°ƒç”¨æ¨¡å¼
- å‡å°‘è¯¯æ“ä½œçš„å¯èƒ½æ€§
- æä¾›å¯å‚è€ƒçš„å…·ä½“æ¡ˆä¾‹

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### å†·å´æœŸæ£€æŸ¥çš„å®ç°åŸç†

1. **æ•°æ®æº:** `partial_take_profit_history` è¡¨
   - è®°å½•æ‰€æœ‰åˆ†æ‰¹æ­¢ç›ˆæ“ä½œ
   - åŒ…å« `timestamp`, `symbol`, `status` å­—æ®µ

2. **æ£€æŸ¥é€»è¾‘:**

   ```bash
   å¦‚æœ (æœ€è¿‘ä¸€æ¬¡æˆåŠŸçš„åˆ†æ‰¹æ­¢ç›ˆæ—¶é—´ - å½“å‰æ—¶é—´) < 5åˆ†é’Ÿ
   åˆ™ æ‹’ç»ç§»åŠ¨æ­¢æŸ
   ```

3. **è¿”å›å€¼:**
   - `success: false` - æ˜ç¡®å‘ŠçŸ¥ AI æ“ä½œè¢«æ‹’ç»
   - `message` - åŒ…å«å…·ä½“çš„å†·å´æ—¶é—´ä¿¡æ¯

### AI Prompt æ¡ˆä¾‹çš„è®¾è®¡åŸåˆ™

1. **å¯¹æ¯”å­¦ä¹ :** æ­£ç¡®æ¡ˆä¾‹ vs é”™è¯¯æ¡ˆä¾‹
2. **å…·ä½“åŒ–:** ä½¿ç”¨çœŸå®çš„ä»·æ ¼å’Œç™¾åˆ†æ¯”
3. **æ­¥éª¤åŒ–:** æ¸…æ™°çš„1ï¸âƒ£ 2ï¸âƒ£ 3ï¸âƒ£ ç¼–å·
4. **å¯è§†åŒ–:** ä½¿ç”¨è¡¨æƒ…ç¬¦å·å’Œç¬¦å·æ ‡è®°
5. **å…³è”æ€§:** æ¡ˆä¾‹ç›´æ¥å¯¹åº”å·¥å…·è°ƒç”¨è§„åˆ™

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### çŸ­æœŸæ•ˆæœï¼ˆ1-3å¤©ï¼‰

- âœ… å‡å°‘å·¥å…·é‡å¤è°ƒç”¨çš„æ—¥å¿—è­¦å‘Š
- âœ… é¿å…åŒä¸€å‘¨æœŸå†…å¤šæ¬¡ç§»åŠ¨æ­¢æŸ
- âœ… AI æ›´æ¸…æ¥šåœ°ç†è§£å·¥å…·è°ƒç”¨é¡ºåº

### ä¸­æœŸæ•ˆæœï¼ˆ1-2å‘¨ï¼‰

- âœ… åˆ†æ‰¹æ­¢ç›ˆæµç¨‹æ›´åŠ ç¨³å®š
- âœ… å‡å°‘è¯¯æ“ä½œå¯¼è‡´çš„èµ„é‡‘æŸå¤±
- âœ… æé«˜ç³»ç»Ÿæ•´ä½“çš„å¯é æ€§

### é•¿æœŸæ•ˆæœï¼ˆ1ä¸ªæœˆ+ï¼‰

- âœ… å»ºç«‹æ ‡å‡†çš„å·¥å…·è°ƒç”¨æ¨¡å¼
- âœ… ä¸ºå…¶ä»–ç­–ç•¥æä¾›å‚è€ƒæ¡ˆä¾‹
- âœ… é™ä½ç³»ç»Ÿç»´æŠ¤æˆæœ¬

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•

- [ ] æµ‹è¯•å†·å´æœŸæ£€æŸ¥ï¼šæœ€è¿‘5åˆ†é’Ÿå†…æœ‰åˆ†æ‰¹æ­¢ç›ˆè®°å½•
- [ ] æµ‹è¯•å†·å´æœŸæ£€æŸ¥ï¼šè¶…è¿‡5åˆ†é’Ÿåå…è®¸ç§»åŠ¨æ­¢æŸ
- [ ] æµ‹è¯•å†·å´æœŸæ£€æŸ¥ï¼šæ•°æ®åº“æŸ¥è¯¢å¤±è´¥çš„å¤„ç†

### é›†æˆæµ‹è¯•

- [ ] å®Œæ•´çš„åˆ†æ‰¹æ­¢ç›ˆæµç¨‹ï¼šstage1 â†’ stage2 â†’ stage3
- [ ] éªŒè¯å†·å´æœŸæœºåˆ¶åœ¨å®é™…äº¤æ˜“ä¸­çš„è¡¨ç°
- [ ] ç›‘æ§ AI çš„å®é™…å·¥å…·è°ƒç”¨æ¨¡å¼

### ç”Ÿäº§éªŒè¯

- [ ] å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼Œè®°å½•æ‰€æœ‰å·¥å…·è°ƒç”¨
- [ ] ç›‘æ§ `updateTrailingStop` è¢«å†·å´æœŸæ‹’ç»çš„æ¬¡æ•°
- [ ] æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é‡å¤ç§»åŠ¨æ­¢æŸçš„æƒ…å†µ

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœä¼˜åŒ–å¯¼è‡´é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤å›æ»šï¼š

### å›æ»šä¼˜åŒ–1ï¼ˆå·¥å…·å±‚å†·å´æœŸï¼‰

**æ­¥éª¤:**

1. åœ¨ `stopLossManagement.ts` ä¸­ç§»é™¤å†·å´æœŸæ£€æŸ¥ä»£ç 
2. ç§»é™¤ `dbClient` å¯¼å…¥å’Œå®ä¾‹åˆ›å»º
3. é‡æ–°ç¼–è¯‘å¹¶éƒ¨ç½²

**å½±å“:**

- å·¥å…·å±‚ä¸å†æ£€æŸ¥å†·å´æœŸ
- å®Œå…¨ä¾èµ– AI éµå®ˆ prompt è§„åˆ™

### å›æ»šä¼˜åŒ–2ï¼ˆPrompt æ¡ˆä¾‹è¯´æ˜ï¼‰

**æ­¥éª¤:**

1. åœ¨ `tradingAgent.ts` ä¸­ç§»é™¤æ–°å¢çš„æ¡ˆä¾‹è¯´æ˜ç« èŠ‚
2. ä¿ç•™åŸæœ‰çš„å·¥å…·è°ƒç”¨è§„åˆ™
3. é‡æ–°éƒ¨ç½²

**å½±å“:**

- AI å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´ç†è§£è§„åˆ™
- å¯èƒ½å‡ºç°æ›´å¤šè¯¯æ“ä½œ

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### ä¼˜åŒ–3: çŠ¶æ€è·Ÿè¸ªæ—¥å¿—ï¼ˆå¯é€‰ï¼‰

ä½¿ç”¨å†…å­˜æˆ– Redis è·Ÿè¸ªæœ€è¿‘çš„å·¥å…·è°ƒç”¨:

```typescript
const recentExecutions = new Map<string, number>(); // symbol -> timestamp

// åœ¨ executePartialTakeProfit æˆåŠŸå
recentExecutions.set(symbol, Date.now());
setTimeout(() => recentExecutions.delete(symbol), 5 * 60 * 1000);

// åœ¨ updateTrailingStop ä¸­æ£€æŸ¥
const lastExecution = recentExecutions.get(symbol);
if (lastExecution && (Date.now() - lastExecution) < 5 * 60 * 1000) {
  return { success: false, message: "å†·å´æœŸå†…" };
}
```

**ä¼˜ç‚¹:**

- æ›´å¿«çš„æŸ¥è¯¢é€Ÿåº¦ï¼ˆæ— éœ€æ•°æ®åº“æŸ¥è¯¢ï¼‰
- é€‚ç”¨äºé«˜é¢‘äº¤æ˜“åœºæ™¯

**ç¼ºç‚¹:**

- éœ€è¦é¢å¤–çš„å†…å­˜ç®¡ç†
- è¿›ç¨‹é‡å¯åçŠ¶æ€ä¸¢å¤±

### ä¼˜åŒ–4: å¯é…ç½®çš„å†·å´æœŸ

å°†å†·å´æœŸæ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰æå–ä¸ºç¯å¢ƒå˜é‡:

```typescript
const STOP_LOSS_COOLDOWN_MINUTES = parseInt(process.env.STOP_LOSS_COOLDOWN_MINUTES || "5", 10);
```

**ä¼˜ç‚¹:**

- æ ¹æ®äº¤æ˜“ç­–ç•¥çµæ´»è°ƒæ•´
- æ–¹ä¾¿ A/B æµ‹è¯•ä¸åŒçš„å†·å´æ—¶é—´

### ä¼˜åŒ–5: æ›´ç»†ç²’åº¦çš„å·¥å…·è°ƒç”¨ç›‘æ§

æ·»åŠ ä¸“é—¨çš„ç›‘æ§è¡¨ `tool_call_history`:

```sql
CREATE TABLE tool_call_history (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  symbol TEXT NOT NULL,
  tool_name TEXT NOT NULL,
  parameters TEXT,
  result TEXT,
  timestamp TEXT NOT NULL
);
```

**ç”¨é€”:**

- åˆ†æ AI çš„å·¥å…·è°ƒç”¨æ¨¡å¼
- å‘ç°æ½œåœ¨çš„ä¼˜åŒ–ç©ºé—´
- ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š

---

## ğŸ¯ æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–é€šè¿‡ä¸¤ä¸ªå…³é”®æ”¹è¿›:

1. **å·¥å…·å±‚å†·å´æœŸæ£€æŸ¥** - æŠ€æœ¯å±‚é¢çš„ç¡¬æ€§ä¿æŠ¤
2. **Prompt æ¡ˆä¾‹è¯´æ˜** - AI ç†è§£å±‚é¢çš„è½¯æ€§å¼•å¯¼

å®ç°äº†"åŒé‡ä¿æŠ¤"æœºåˆ¶ï¼Œç¡®ä¿å³ä½¿ AI ä¸å®Œå…¨ç†è§£è§„åˆ™ï¼Œç³»ç»Ÿä¹Ÿèƒ½é€šè¿‡å·¥å…·å±‚æ‹’ç»é”™è¯¯æ“ä½œã€‚

**æ ¸å¿ƒåŸåˆ™:** ä¿¡ä»»ä½†éªŒè¯ (Trust but Verify)

- ä¿¡ä»» AI æœ‰ç†è§£å’Œå­¦ä¹ èƒ½åŠ›
- éªŒè¯æ¯ä¸ªå…³é”®æ“ä½œçš„åˆç†æ€§

**ä¸‹ä¸€æ­¥:**

- åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
- ç›‘æ§ç”Ÿäº§ç¯å¢ƒè¡¨ç°
- æ ¹æ®æ•°æ®æŒç»­ä¼˜åŒ–
