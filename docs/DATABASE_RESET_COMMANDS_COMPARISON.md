# 数据库重置命令对比说明

## 📋 命令对比

### 1. `npm run db:reset`

**执行文件:** `src/database/reset.ts`

**功能:**

- ✅ 仅重置数据库（本地操作）
- ✅ 删除所有数据库表
- ✅ 重新创建所有表
- ✅ 插入初始资金记录

**不包含:**

- ❌ 不取消交易所的条件单
- ❌ 不平仓交易所的持仓
- ❌ 不同步交易所数据

**适用场景:**

1. **开发测试** - 快速清空数据库,不影响交易所
2. **数据损坏修复** - 数据库出现问题需要重建
3. **调整初始资金** - 更改 `INITIAL_BALANCE` 后重新初始化
4. **离线重置** - 不需要连接交易所的情况

**执行流程:**

```bash
1. 删除所有表
   ├─ trade_logs
   ├─ agent_decisions
   ├─ trading_signals
   ├─ positions
   ├─ account_history
   ├─ price_orders
   ├─ position_close_events
   └─ partial_take_profit_history

2. 重新创建所有表

3. 插入初始账户记录
   └─ 使用 INITIAL_BALANCE 环境变量
```

---

### 2. `npm run db:close-and-reset`

**执行文件:** `scripts/close-reset-and-start.sh` → `src/database/close-and-reset.ts`

**功能:**

- ✅ **取消交易所的所有条件单（止损止盈订单）**
- ✅ **平仓交易所的所有持仓**
- ✅ 重置数据库（删除+重建）
- ✅ 从交易所同步持仓数据
- ✅ 显示完整的系统状态

**包含:**

- ✅ 交易所操作（取消订单、平仓）
- ✅ 本地数据库重置
- ✅ 数据同步

**适用场景:**

1. **生产环境重启** - 完全清空线上状态,重新开始
2. **策略切换** - 更换交易策略前清理所有持仓
3. **紧急止损** - 快速平掉所有持仓并重置
4. **定期清理** - 定期清空所有交易记录和持仓
5. **交易所与数据库不同步** - 完全重置并重新同步

**执行流程:**

```bash
【步骤 1/4】取消所有条件单（止损止盈订单）
   ├─ Gate.io: 取消所有合约的条件单
   └─ Binance: 获取所有未成交订单并逐个合约取消
   └─ 等待 1 秒

【步骤 2/4】平仓所有持仓
   ├─ 获取交易所当前持仓
   ├─ 逐个平仓（市价单 + reduceOnly）
   └─ 等待 2 秒

【步骤 3/4】重置数据库
   ├─ 删除所有表
   ├─ 重新创建所有表
   └─ 插入初始账户记录

【步骤 4/4】从交易所同步持仓数据
   ├─ 获取交易所当前持仓
   ├─ 清空本地 positions 表
   └─ 同步持仓到数据库
```

---

## 🎯 使用建议

### 场景 1: 开发测试 - 使用 `db:reset`

```bash
# 快速重置数据库,不影响交易所
npm run db:reset
```

**优势:**

- ⚡ 速度快（不需要连接交易所）
- 🔒 安全（不会影响交易所的实际持仓）
- 🧪 适合频繁测试

**示例场景:**

- 测试新功能时需要干净的数据库
- 修改数据库 schema 后需要重建
- 开发环境快速重置

---

### 场景 2: 生产重启 - 使用 `db:close-and-reset`

```bash
# 完全重置:平仓 + 重置数据库 + 同步
npm run db:close-and-reset
```

**优势:**

- 🎯 完整重置（交易所 + 数据库）
- 🔄 自动同步（确保数据一致）
- 📊 完整报告（显示所有操作结果）

**示例场景:**

- 生产环境需要完全重启
- 切换交易策略
- 发现数据不同步需要修复
- 紧急情况需要清空所有持仓

---

## 🤔 是否可以合并？

### ❌ 不建议合并,原因如下

#### 1. **使用场景完全不同**

- 开发场景 vs 生产场景**

  - `db:reset` - 开发测试用,频繁使用,不影响交易所
  - `db:close-and-reset` - 生产环境用,慎重操作,会平仓

#### 2. **风险级别不同**

- 低风险 vs 高风险**

  - `db:reset` - ✅ 零风险（仅操作本地数据）
  - `db:close-and-reset` - ⚠️ 高风险（会平掉所有真实持仓）

#### 3. **执行时间不同**

- 快速 vs 慢速**

  - `db:reset` - 1-2 秒（本地操作）
  - `db:close-and-reset` - 10-30 秒（需要调用交易所 API）

#### 4. **依赖条件不同**

- 离线 vs 在线**

  - `db:reset` - 无需交易所连接
  - `db:close-and-reset` - 必须连接交易所

#### 5. **用户意图不同**

- 轻量级 vs 重量级**

  - `db:reset` - "我只想清理数据库"
  - `db:close-and-reset` - "我要完全重置交易系统"

---

## 🔄 改进建议

### 建议 1: 保持独立,增强文档

**当前方案（推荐）:**

```bash
# 仅重置数据库（开发测试用）
npm run db:reset

# 完全重置（生产环境用）
npm run db:close-and-reset
```

**优势:**

- ✅ 职责清晰
- ✅ 降低误操作风险
- ✅ 满足不同场景需求

---

### 建议 2: 如果一定要合并（不推荐）

可以添加交互式提示:

```typescript
// reset.ts 增强版（不推荐）
async function resetDatabase(options?: { closePositions: boolean }) {
  if (options?.closePositions) {
    console.log("⚠️  警告: 此操作将平掉所有交易所持仓!");
    const answer = await prompt("确认执行吗？(yes/no): ");
    if (answer !== "yes") {
      return;
    }
    
    // 执行平仓操作
    await cancelAllConditionalOrders();
    await closeAllPositions();
  }
  
  // 重置数据库
  // ...
}
```

**缺点:**

- ❌ 增加复杂度
- ❌ 容易误操作
- ❌ 不符合 Unix 哲学（一个工具做一件事）

---

## 📊 命令对比表

| 特性 | `npm run db:reset` | `npm run db:close-and-reset` |
|------|-------------------|------------------------------|
| **取消条件单** | ❌ 否 | ✅ 是 |
| **平仓持仓** | ❌ 否 | ✅ 是 |
| **重置数据库** | ✅ 是 | ✅ 是 |
| **同步持仓** | ❌ 否 | ✅ 是 |
| **需要交易所连接** | ❌ 否 | ✅ 是 |
| **执行时间** | 1-2 秒 | 10-30 秒 |
| **风险级别** | 🟢 低 | 🔴 高 |
| **适用环境** | 开发/测试 | 生产 |
| **是否影响交易所** | ❌ 否 | ✅ 是 |
| **停止进程** | ❌ 否 | ✅ 是（shell 版本） |
| **显示状态** | ❌ 否 | ✅ 是（shell 版本） |

---

## 🎓 最佳实践

### 开发环境

```bash
# 1. 修改代码后快速测试
npm run db:reset
npm run trading:start

# 2. 测试完成,再次重置
npm run db:reset
```

### 生产环境

```bash
# 1. 完全重启系统（慎重！）
npm run db:close-and-reset

# 2. 检查状态
npm run db:status

# 3. 重新启动
npm run trading:start
```

### 紧急情况

```bash
# 快速平仓所有持仓（不重置数据库）
# 可以添加专门的命令: npm run db:close-positions

# 或使用完整重置
npm run db:close-and-reset
```

---

## 🚀 未来改进方向

### 可选: 添加更细粒度的命令

```json
{
  "scripts": {
    "db:reset": "仅重置数据库（当前）",
    "db:close-positions": "仅平仓（新增）",
    "db:cancel-orders": "仅取消条件单（新增）",
    "db:close-and-reset": "完全重置（当前）",
    "db:sync": "仅同步数据（已有）"
  }
}
```

**优势:**

- ✅ 更灵活的组合
- ✅ 降低误操作风险
- ✅ 满足更多场景

---

## ✅ 结论

**保持两个命令独立是最佳方案:**

1. ✅ **`db:reset`** - 轻量级、快速、安全的本地重置
2. ✅ **`db:close-and-reset`** - 完整的、包含交易所操作的重置

**不建议合并的原因:**

- 使用场景完全不同
- 风险级别差异巨大
- 执行时间相差很多
- 依赖条件不同
- 用户意图不同

**建议:**

- 📖 在文档中清楚说明两者区别
- ⚠️ 在交互式命令中添加警告提示
- 🔐 考虑为 `db:close-and-reset` 添加二次确认
- 📚 提供使用示例和最佳实践

---

**更新日期:** 2025-01-15  
**作者:** losesky  
**License:** GNU AGPL v3
